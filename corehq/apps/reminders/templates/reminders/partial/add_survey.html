{% extends "reminders/survey_base.html" %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
    function remove_contact_record(ref) {
        cell_ref = ref.parentNode;
        row_ref = cell_ref.parentNode;
        table_ref = row_ref.parentNode;
        table_ref.removeChild(row_ref);
    }
    
    function create_contact_record() {
        var tr = document.createElement("TR");
        var td1 = document.createElement("TD");
        var td2 = document.createElement("TD");
        var td3 = document.createElement("TD");
        var td4 = document.createElement("TD");
        var td5 = document.createElement("TD");
        var input1 = document.createElement("INPUT");
        input1.setAttribute("type", "text");
        input1.setAttribute("class", "short");
        input1.setAttribute("name", "sample_contact." + current_sample_contact_num + ".id");
        var input2 = document.createElement("INPUT");
        input2.setAttribute("type", "text");
        input2.setAttribute("name", "sample_contact." + current_sample_contact_num + ".phone_number");
        var select1 = document.createElement("SELECT");
        select1.setAttribute("name", "sample_contact." + current_sample_contact_num + ".method");
        {% for method in method_list %}
        var option = document.createElement("OPTION");
        option.setAttribute("value", "{{ method }}");
        option.innerHTML = "{{ method }}";
        select1.appendChild(option);
        {% endfor %}
        var select2 = document.createElement("SELECT");
        select2.setAttribute("name", "sample_contact." + current_sample_contact_num + ".cati_operator");
        {% for user in user_list %}
        var option = document.createElement("OPTION");
        option.setAttribute("value", "{{ user.get_id }}");
        option.innerHTML = "{{ user.raw_username }}";
        select2.appendChild(option);
        {% endfor %}
        var button = document.createElement("SPAN");
        button.setAttribute("class", "btn btn-danger");
        button.innerHTML = '<i class="icon icon-white icon-remove"></i> Remove';
        button.onclick = function() { remove_contact_record(this); };
        //
        current_sample_contact_num++;
        //
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tr.appendChild(td5);
        td1.appendChild(input1);
        td2.appendChild(input2);
        td3.appendChild(select1);
        td4.appendChild(select2);
        td5.appendChild(button);
        //
        return tr;
    }
    
    function add_contact_record() {
        document.getElementById("sample").appendChild(create_contact_record());
    }
    
    function sample_changed() {
        document.getElementById("refresh_sample").setAttribute("value", "1");
        document.getElementById("loading_message").setAttribute("style", "display: inline;");
        form = document.getElementById("survey_form");
        form.setAttribute("action","#load_sample");
        form.submit();
    }
    
    {% if form.sample_contacts.value|length == 0 %}
    var current_sample_contact_num = 1;
    {% else %}
    var current_sample_contact_num = {{ form.sample_contacts.value|length }};
    {% endif %}
</script>

{% endblock %}

{% block survey_content %}
<br />
<form id="survey_form" action="#" method="post">
    <h2>Survey</h2>
    <br />
    <table>
        {% if form.name.errors %}
        <tr>
            <th></th>
            <td>{{ form.name.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Name:</th>
            <td>{{ form.name }}</td>
        </tr>
        {% if form.form_id.errors %}
        <tr>
            <th></th>
            <td>{{ form.form_id.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Questionnaire:</th>
            <td>
                <select name="form_id">
                    {% for f in form_list %}
                        <option value="{{ f.code }}" {% if f.code == form.form_id.value %}selected="selected"{% endif %}>{{ f.name }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
    </table>

    <h2>Schedule</h2>
    <br />
    <table>
        <tr>
            <th></th>
            <td><input type="checkbox" name="send_automatically" {% if form.send_automatically.value %}value="on" checked="checked"{% endif %}/> Send Automatically</td>
        </tr>
        {% if form.schedule_date.errors %}
        <tr>
            <th></th>
            <td>{{ form.schedule_date.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Date:</th>
            <td>{{ form.schedule_date }}</td>
        </tr>
        {% if form.schedule_time.errors %}
        <tr>
            <th></th>
            <td>{{ form.schedule_time.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Time:</th>
            <td>{{ form.schedule_time }}</td>
        </tr>
    </table>

    <a id="load_sample"></a>
    <h2>Sample</h2>
    <br />
    <table>
        {% if form.sample_id.errors %}
        <tr>
            <th></th>
            <td>{{ form.sample_id.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Choose:</th>
            <td>
                <select name="sample_id" onChange="sample_changed();">
                    {% for s in sample_list %}
                        <option value="{{ s.code }}" {% if s.code == form.sample_id.value %}selected="selected"{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
                <span id="loading_message" style="display: none;">Loading, please wait...</span>
            </td>
        </tr>
        {% if form.sample_name.errors %}
        <tr>
            <th></th>
            <td>{{ form.sample_name.errors }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Name:</th>
            <td><input name="sample_name" type="text" value="{% if form.refresh_sample.value == "1" %}{{ form.refresh_sample_name }}{% else %}{{ form.sample_name.value|default:"" }}{% endif %}"></td>
        </tr>
    </table>

    {% if form.sample_contacts.errors %}
    <tr>
        <th></th>
        <td>{{ form.sample_contacts.errors }}</td>
    </tr>
    {% endif %}
    <table id="sample">
        <tr>
            <th>ID</th>
            <th>Phone Number</th>
            <th>Method</th>
            <th>CATI Operator</th>
            <th></th>
        </tr>
        {% if form.refresh_sample.value == "1" %}
            {% if form.refresh_sample_contacts|length == 0 %}
            <tr>
                <td><input name="sample_contact.0.id" type="text" class="short" /></td>
                <td><input name="sample_contact.0.phone_number" type="text" /></td>
                <td><select name="sample_contact.0.method">{% for method in method_list %}<option value="{{ method }}">{{ method }}</option>{% endfor %}</select></td>
                <td><select name="sample_contact.0.cati_operator">{% for user in user_list %}<option value="{{ user.get_id }}">{{ user.raw_username }}</option>{% endfor %}</select></td>
                <td><span class="btn btn-danger" onClick="remove_contact_record(this);"><i class="icon icon-white icon-remove"></i> Remove</span></td>
            </tr>
            {% else %}
                {% for contact in form.refresh_sample_contacts %}
                <tr>
                    <td><input name="sample_contact.{{ forloop.counter0 }}.id" type="text" class="short" value="{{ contact.id }}" /></td>
                    <td><input name="sample_contact.{{ forloop.counter0 }}.phone_number" type="text" value="{{ contact.phone_number }}" /></td>
                    <td><select name="sample_contact.{{ forloop.counter0 }}.method">{% for method in method_list %}<option value="{{ method }}" {% if contact.method == method %}selected="selected"{% endif %}>{{ method }}</option>{% endfor %}</select></td>
                    <td><select name="sample_contact.{{ forloop.counter0 }}.cati_operator">{% for user in user_list %}<option value="{{ user.get_id }}" {% if contact.cati_operator == user.get_id %}selected="selected"{% endif %}>{{ user.raw_username }}</option>{% endfor %}</select></td>
                    <td><span class="btn btn-danger" onClick="remove_contact_record(this);"><i class="icon icon-white icon-remove"></i> Remove</span></td>
                </tr>
                {% endfor %}
            {% endif %}
        {% else %}
            {% if form.sample_contacts.value|length == 0 %}
            <tr>
                <td><input name="sample_contact.0.id" type="text" class="short" /></td>
                <td><input name="sample_contact.0.phone_number" type="text" /></td>
                <td><select name="sample_contact.0.method">{% for method in method_list %}<option value="{{ method }}">{{ method }}</option>{% endfor %}</select></td>
                <td><select name="sample_contact.0.cati_operator">{% for user in user_list %}<option value="{{ user.get_id }}">{{ user.raw_username }}</option>{% endfor %}</select></td>
                <td><span class="btn btn-danger" onClick="remove_contact_record(this);"><i class="icon icon-white icon-remove"></i> Remove</span></td>
            </tr>
            {% else %}
                {% for contact in form.sample_contacts.value %}
                <tr>
                    <td><input name="sample_contact.{{ forloop.counter0 }}.id" type="text" class="short" value="{{ contact.id }}" /></td>
                    <td><input name="sample_contact.{{ forloop.counter0 }}.phone_number" type="text" value="{{ contact.phone_number }}" /></td>
                    <td><select name="sample_contact.{{ forloop.counter0 }}.method">{% for method in method_list %}<option value="{{ method }}" {% if contact.method == method %}selected="selected"{% endif %}>{{ method }}</option>{% endfor %}</select></td>
                    <td><select name="sample_contact.{{ forloop.counter0 }}.cati_operator">{% for user in user_list %}<option value="{{ user.get_id }}" {% if contact.cati_operator == user.get_id %}selected="selected"{% endif %}>{{ user.raw_username }}</option>{% endfor %}</select></td>
                    <td><span class="btn btn-danger" onClick="remove_contact_record(this);"><i class="icon icon-white icon-remove"></i> Remove</span></td>
                </tr>
                {% endfor %}
            {% endif %}
        {% endif %}
    </table>
    <span class="btn btn-success" onClick="add_contact_record();"><i class="icon icon-white icon-plus"></i> Add Contact</span>
    <br />
    <br />
    <h2></h2>
    <br />
    <input id="refresh_sample" type="hidden" name="refresh_sample" value="0" />
    <input type="submit" class="btn btn-primary" value="Submit" />
</form>

{% endblock %}
