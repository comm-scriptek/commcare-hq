{% load i18n %}

<script type="text/html" id="remove-subcase-modal-template">
    <div class="modal-header">
        <a href="#" class="close" data-dismiss="modal">Ã—</a>
        <h3>{% trans "Remove Subcase?" %}</h3>
    </div>
    <div class="modal-body">
        <p>{% trans "Are you sure you want to remove this subcase?" %}</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">{% trans "Cancel" %}</a>
        <a class="btn btn-danger" href="#" data-bind="click: $parent.removeSubCase" data-dismiss="modal">{% trans "Remove Subcase" %}</a>
    </div>
</script>

<script type="text/html" id="case-config:condition">
    <div data-bind="visible: type() === 'always' && $root.edit">
        <a href="#" data-bind="click: function () {type('if')}"><i class="icon-plus"></i> {% trans "Use condition..." %}</a>
    </div>
    <div data-bind="visible: type() === 'if'">
        <a href="#" data-bind="click: function () {type('always')}, visible: $root.edit"><i class="icon-remove"></i></a>
        {% trans "If the answer to" %}
        <select data-bind="
            optstr: $root.getQuestions('select1', false, true),
            value: question,
            optionsCaption: ' ',
            edit: $root.edit"
        ></select>
        {% trans "is" %}
        <span data-bind="if: $root.getAnswers({question: question()}).length">
            <select data-bind="
                optstr: $root.getAnswers({question: question()}),
                value: answer,
                edit: $root.edit"></select>
        </span>
        <span data-bind="if: !$root.getAnswers({question: question()}).length">
            <input type="text" class="code" data-bind="value: answer, edit: $root.edit"/>
        </span>
    </div>
</script>

<script type="text/html" id="case-config:case-properties:question">
    <select data-bind="
        optstr: $root.getQuestions('all', false, case_transaction.allow.repeats()),
        optstrText: $root.utils.getLabel,
        value: path,
        optionsCaption: ' ',
        edit: $root.edit"
    ></select>
    <p class="help-inline" data-bind="visible: required() && !path()">{% trans "Required" %}</p>
</script>

<script type="text/html" id="case-config:case-properties:property">
    <span data-bind="visible: !required()">
        <input type="text" class="code" data-bind="valueDefault: key, default: defaultKey, edit: $root.edit"/>
    </span>
    <span data-bind="visible: required()">
        <code data-bind="text: key"></code>
    </span>
</script>

<script type="text/html" id="case-config:open-case">
    <div data-bind="template: {name: 'case-config:condition', data: condition}, visible: allow.condition()"></div>
    <div data-bind="css: {'row-fluid': allow.case_preload()}">
        <div data-bind="if: allow.case_preload(), css: {span6: allow.case_preload(), hide: !allow.case_preload()}" class="well">
            <em>{% trans "Load the following case properties into the form" %}</em>
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th></th>
                        <th>{% trans "Case Property" %}</th>
                        <th></th>
                        <th>{% trans "Question" %}</th>
                    </tr>
                </thead>

                <tbody data-bind="foreach: case_preload">
                    <tr class="control-group" data-bind="css: {error: validateProperty() || validateQuestion}">
                        <td>
                            <a href="#" data-bind="
                                click: $parent.removePreload,
                                visible: $root.edit">
                                <i class="icon-remove"></i>
                            </a>
                        </td>
                        <td>
                            <div data-bind="template: 'case-config:case-properties:property'"></div>
                            <p class="help-inline" data-bind="html: validateProperty, visible: validateProperty"></p>
                        </td>
                        <td>
                            <i class="icon-arrow-right"></i>
                        </td>
                        <td>
                            <div data-bind="template: 'case-config:case-properties:question'"></div>
                            <p class="help-inline" data-bind="html: validateQuestion, visible: validateQuestion"></p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <a href="#" data-bind="click: addPreload, visible: $root.edit">
                <i class="icon-plus"></i>
                {% trans "Load another property" %}
            </a>
        </div>
        <div data-bind="css: {span6: allow.case_preload()}" class="well">
            <em>{% trans "Save data to the following case properties" %}</em>
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th></th>
                        <th>{% trans "Question" %}</th>
                        <th></th>
                        <th>{% trans "Case Property" %}</th>
                    </tr>
                </thead>

                <tbody data-bind="foreach: case_properties">
                    <tr class="control-group" data-bind="css: {error: validate, warning: !validate() && required() && !path()}">
                        <td>
                            <a href="#" data-bind="click: $parent.removeProperty, visible: $root.edit && !required()">
                                <i class="icon-remove"></i>
                            </a>
                        </td>
                        <td>
                            <div data-bind="template: 'case-config:case-properties:question'"></div>
                        </td>
                        <td>
                            <i class="icon-arrow-right"></i>
                        </td>
                        <td>
                            <div data-bind="template: 'case-config:case-properties:property'"></div>
                            <p class="help-inline" data-bind="html: validate, visible: validate"></p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <a href="#" data-bind="click: addProperty, visible: $root.edit">
                <i class="icon-plus"></i>
                {% trans "Add property" %}
            </a>
        </div>
    </div>
    <div data-bind="visible: allow.close_condition()" class="well">
        <label>
            <input type="checkbox" data-bind="checked: close_case"/>
            {% trans "Close Case" %}
        </label>
        <div data-bind="template: {name: 'case-config:condition', data: $data.close_condition, if: $data.close_condition}"></div>
    </div>
</script>


<div id="case-config-ko">
    <div data-bind="saveButton: saveButton, visible: $root.edit"></div>
    <div data-bind="with: caseConfigViewModel">
        <div>
            {% trans "This form" %}
            <select data-bind="
                optstr: [{value: 'none', label: '{% trans "does not use cases" %}'},
                         {value: 'open', label: '{% trans "opens a case" %}'},
                         {value: 'update', label: '{% trans "modifies a case" %}'}],
                value: actionType
            "></select>
        </div>
        <div data-bind="if: actionType() === 'update'">
            <div data-bind="template: {name: 'case-config:open-case', data: case_transaction}">
            </div>
        </div>
        <div data-bind="if: actionType() === 'open'">
            <div data-bind="template: {name: 'case-config:open-case', data: case_transaction}">
            </div>
        </div>
        <header class="clearfix">
            <h5 class="pull-left">{% trans "Child Cases" %}</h5>
            <span data-bind="makeHqHelp: {}"
              data-title="{% trans "Child Cases" %}"
              data-content="{% trans "Child Cases let you open other types of cases for use in other modules. When possible, they'll be linked to the current case so you'll always know where they came from. A great use of Child Cases is for tracking a newborn separately from its mother." %}"
            ></span>
        </header>

        <div data-bind="foreach: subcases" class="form">
            <div>
                <i class="icon-ok"></i>
                {% trans "Opens a case for a different case list:" %}
                <span class="control-group" data-bind="css: {warning: !case_type()}">
                    <select data-bind="
                        options: $parent.caseTypes,
                        optionsText: $parent.getCaseTypeLabel,
                        value: case_type,
                        optionsCaption: 'Choose a Module...',
                        edit: $root.edit"
                    ></select>
                    <span class="help-inline" data-bind="visible: !case_type()">{% trans "Required" %}</span>
                </span>
                <a href="#" data-bind="openModal: 'remove-subcase-modal-template', visible: $root.edit" class="pull-right">
                    <i class="icon-trash"></i>
                    {% trans "Remove subcase" %}
                </a>
            </div>
            <div data-bind="template: 'case-config:open-case'"></div>
        </div>
        <div>
            <a href="#" data-bind="click: addSubCase, visible: $root.edit">
                <i class="icon-plus"></i>
                {% trans "Opens a case for a different case list..." %}
            </a>
        </div>
    </div>
</div>
