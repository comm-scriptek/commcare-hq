  {% load xforms_extras %}
<suite version="{{ app.version }}">

 {% for module in app.get_modules %}
  {% for  form in module.get_forms %}
    <!-- Parse and cache the XForm -->
    <xform>
        <resource id="{{ form.unique_id }}" version="{{ app.version }}">
           <location authority="local">./modules-{{ module.id }}/forms-{{ form.id }}.xml</location>
           <location authority="remote">./modules-{{ module.id }}/forms-{{ form.id }}.xml</location>
        </resource>
    </xform>
  {% endfor %}
 {% endfor %}
 {% if app.show_user_registration %}
    <xform>
        <resource id="{{ form.unique_id }}" version="{{ app.version }}">
           <location authority="local">./user_registration.xml</location>
           <location authority="remote">./user_registration.xml</location>
        </resource>
    </xform>
 {% endif %}
 {% for lang in langs %}
    <!-- Read and locally store the translation strings-->
    <locale language="{{ lang }}">
        <resource id="app_{{ lang }}_strings" version="{{ app.version }}">
           <location authority="local">./{{ lang }}/app_strings.txt</location>
           <location authority="remote">./{{ lang }}/app_strings.txt</location>
        </resource>
    </locale>
 {% endfor %}
{% if not app.use_custom_suite %}
 {% for module in app.get_modules %}
  {% for detail in module.details %}
   {% if detail.columns %}
    {% if detail.type == 'case_short' or  detail.type == 'case_long' %}
    <detail id="m{{ module.id }}_{{ detail.type }}">
        <title><text><locale id="m{{ module.id }}.{{ detail.type }}.title"/></text></title>
     {% for d in detail.columns %}
        {% if d.format != 'filter' %}
        <field{% if forloop.first %} sort="default"{% endif %}>
            <header{% if d.format == "late-flag" or d.format == "invisible" %}{% if detail.display == "short" %} width="0"{% endif %}{% endif %}>
                <text><locale id="m{{ module.id }}.{{ detail.type }}.{{ d.model }}_{{ d.field }}_{{ forloop.counter }}.header"/></text>
            </header>
         {% if d.format == "plain" or d.format == "phone" and detail.type == "case_short" or d.format == "phone" and detail.type == "ref_short" %}
            <template><text><xpath function="{{ d.xpath }}"/></text></template>
         {% else %}{% ifequal d.format "date" %}
{#            <template><text><xpath function="format_date({{ d.xpath }}, 'short')"/></text></template>#}
            <template><text><xpath function="if({{ d.xpath }} = '', '', format_date(date(if({{ d.xpath }} = '', 0, {{ d.xpath }})),'short'))"/></text></template>
         {% else %}{% ifequal d.format "advanced" %}
            <template><text><xpath function="{{ d.model }}_{{ d.field }}_{{ forloop.counter }}"/></text></template>
         {% else %}{% if d.format == "enum" or d.format == "enum-image"%}
             <template{% if d.format == "enum-image" %} form="image"{% endif %}><text>
                 <xpath function="
                  {% for key, val in d.enum.items %}
                     if({{ d.xpath }} = '{{ key }}', ${{ key }},
                  {% endfor %}
                     '?'
                  {% for _ in d.enum %}
                     )
                  {% endfor %}
                 ">
                  {% for key, val in d.enum.items %}
                     <variable name="{{ key }}">
                         <locale id="m{{ module.id }}.{{ detail.type }}.{{ d.model }}_{{ d.field }}_{{ forloop.parentloop.counter }}.enum.{{ key }}{% if d.format == "enum-image" %}.image{% endif %}"/>
                     </variable>
                  {% endfor %}
                 </xpath>
             </text></template>
         {% else %}{% ifequal d.format "years-ago" %}
             <template><text><xpath function="if({{ d.xpath }} = '', '', string(int((today() - date({{ d.xpath }})) div 365.25)))"/></text></template>
         {% else %}{% ifequal d.format "months-ago" %}
             <template><text><xpath function="if({{ d.xpath }} = '', '', string(int((today() - date({{ d.xpath }})) div 30.4375)))"/></text></template>
         {% else %}{% ifequal d.format "late-flag"%}
             <template width="10%"><text><xpath function="if({{ d.xpath }} = '', '*', if(today() - date({{ d.xpath }}) &gt; {{ d.late_flag }}, '*', ''))"/></text></template>
         {% else %}{% ifequal d.format "phone" %}
             <template form="phone"><text><xpath function="{{ d.xpath }}" /></text></template>
         {% else %}{% if d.format == "invisible" %}
             <template{% if detail.display == "short" %} width="0"{% endif %}><text><xpath function="{{ d.xpath }}" /></text></template>
         {% endif %}{% endifequal %}{% endifequal %}{% endifequal %}{% endifequal %}{% endif %}{% endifequal %}{% endifequal %}{% endif %}

        </field>
        {% endif %}
     {% endfor %}
    </detail>
   {% endif %}
   {% endif %}
  {% endfor %}
 {% endfor %}
 {% for module in app.get_modules %}
  {% for form in module.get_forms %}
    <entry>
        <form>{{ form.xmlns }}</form>
        <command id="{{ form.get_command_id }}">
            {% include "app_manager/suite/display.xml" with item=form locale_id=form.get_locale_id %}
        </command>
     {% if form.requires == "case" %}
        <instance id="casedb" src="jr://instance/casedb"/>
        <session>
            <datum id="case_id" nodeset="instance('casedb')/casedb/case[@case_type='{{ module.case_type }}'][@status='open']{{ module.details.0.filter_xpath_2 }}" value="./@case_id" detail-select="m{{ module.id }}_case_short" detail-confirm="m{{ module.id }}_case_long"/>
        </session>
     {% endif %}
    </entry>
  {% endfor %}
  {% if module.case_list.show %}
    <entry>
        <command id="m{{ module.id }}-case-list">
            <text><locale id="case_lists.m{{ module.id }}"/></text>
        </command>
        <instance id="casedb" src="jr://instance/casedb"/>
        <session>
            <datum id="case_id" nodeset="instance('casedb')/casedb/case[@case_type='{{ module.case_type }}'][@status='open']" value="./@case_id" detail-select="m{{ module.id }}_case_short" detail-confirm="m{{ module.id }}_case_long"/>
        </session>
    </entry>
  {% endif %}
 {% endfor %}
 {% for module in app.get_modules %}
  {% if module.name|trans:app.langs == "root" or module.put_in_root %}
    <menu id="root">
  {% else %}
    <menu id="m{{ module.id }}">
  {% endif %}
     {% include "app_manager/suite/display.xml" with item=module locale_id=module.get_locale_id %}
     {% for form in module.get_forms %}
    	<command id="{{ form.get_command_id }}"/>
     {% endfor %}
     {% if module.case_list.show %}
         <command id="m{{ module.id }}-case-list"/>
     {% endif %}
     {% if module.referral_list.show %}
         <command id="m{{ module.id }}-referral-list"/>
     {% endif %}
    </menu>
 {% endfor %}
{% else %}
    {{ app.custom_suite|safe }}
{% endif %}
    {% if app.case_sharing %}
    <fixture id="user-groups" user_id="demo_user">
        <groups>
            <group id="demo_user_group_id">
                <name>Demo Group</name>
            </group>
        </groups>
    </fixture>
    {% endif %}
</suite>
