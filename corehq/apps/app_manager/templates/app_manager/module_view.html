{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load hq_shared_tags %}
{% block js %}{{ block.super }}
    <script src="{% static 'hqwebapp/javascripts/underscore-1.3.1.js' %}"></script>
    <script src="{% static 'hqwebapp/js/guidGenerator.js' %}"></script>
    <script src="{% static 'app_manager/js/lcs-merge.js' %}"></script>
    <script src="{% static 'app_manager/js/detail-screen-config.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
    $(function(){
        var help_text = {
            "Case Type": "e.g. \"pregnant_mother\"\r\n. The value you set for \"Case Type\" will be the name for the type"
            + " of case that this module uses. If you are creating an application for the first time, you can name" +
                    " the case type whatever you like. If you want to be able to interface with the cases of other"
            + "modules, you will have to use the same name for the case type. When you view the case data online, it " +
                    "will be organized by case type. Perhaps you will have one case called \"pregnant_mother\", and " +
                    "another called \"routine_patient\", etc.",
            "Case List": "Whether to have an item in the module's menu that lets you browse the case list without" +
                    "moving on to fill out a form."

        };
        $('.help_popover').popover({
            placement: $(this).data('placement') || 'left',
            title: function () {
                return $(this).attr('data-help-key');
            },
            content: function () {
                return help_text[$(this).attr('data-help-key')];
            }
        });
    });
</script>
{% endblock %}
{% block head %}{{ block.super }}
    <link rel="stylesheet" href="{% static 'app_manager/css/detail-screen-config.css' %}"/>
    <script>
        $(function () {
            var $home = $("#detail-screen-config");
            DetailScreenConfig.init($home, {
                state: {
                    case_short: {{ module.details.0|JSON }},
                    case_long: {{ module.details.1|JSON }},
                    ref_short: {{ module.details.2|JSON }},
                    ref_long: {{ module.details.3|JSON }}
                },
                properties: {
                    'case': ["name", "date-opened", "status", "external-id"].concat({{ case_properties|JSON }}),
                    referral: ["id", "type", "date-due", "date-created"]
                },
                lang: {{ lang|JSON }},
                langs: {{ app.langs|JSON }},
                edit: {{ edit|JSON }},
                saveUrl: "{% url edit_module_detail_screens domain app.id module.id %}"
            });
        });
    </script>

{% endblock %}

{% block form-view %}
    {% if edit %}
    <div class="delete-me">
        <form action="{% url delete_module domain app.id module.id %}" method="post">
            <a class="submit" href="#">
                <span class="ui-icon ui-icon-trash"></span>
                Delete this module
            </a>
        </form>
    </div>
    {% endif %}
    <h3 class="variable-module_name">{{ module.name|html_trans:langs|safe }}</h3>

    <h4>Module Settings</h4>

    <div class="config">
        <form class="save-button-form" action="{% url corehq.apps.app_manager.views.edit_module_attr domain app.id module.id 'all' %}">
            <div class="save-button-holder"></div>
            <table>
                {% if edit %}

                    <tr class="form editable">
                        <th>
                            Module Name
                        </th>
                        <td>
                            {{ module.name|input_trans:langs|safe }}
                        </td>
                    </tr>
                    {% with module as item %}
                        {% include "app_manager/partials/nav_menu_media.html" %}
                    {% endwith %}
                    <tr class="form editable">
                        <th>
                            Case Type
                            <span class="help_popover" data-help-key="Case Type"><span> <i class="icon icon-question-sign"></i></span></span>
                        </th>
                        <td>
                            <input class="code" type="text" name="case_type" value="{{ module.case_type }}"/>
                        </td>
                    </tr>
                    <tr class="form editable">
                        <th>
                            Menu
                        </th>
                        <td>
                            <select class="code" type="text" name="put_in_root" data-value="{% if module.put_in_root %}true{% else %}false{% endif %}">
                                <option value="false">Put forms in a separate menu</option>
                                <option value="true">Put forms on first screen</option>
                            </select>
                        </td>
                    </tr>
                    <tr class="form editable">
                        <th>
                            Case List
                            <span class="help_popover" data-help-key="Case List"><span> <i class="icon icon-question-sign"></i></span></span>
                        </th>
                        <th>
                            <select class="code" type="text" name="case_list-show" data-value="{% if module.case_list.show %}true{% else %}false{% endif %}">
                                <option value="false">Don't Show</option>
                                <option value="true">Show</option>
                            </select>
                            <span>
                                Label: <input type="text" name="case_list-label" value="{{ module.case_list.label|trans:langs }}"/>
                            </span>
                        </th>
                    </tr>
                    <tr class="form editable">
                        <th>
                            Label for Cases
                        </th>
                        <td>
                                <input type="text" name="case_label" value="{{ module.case_label|trans:langs }}" />
                        </td>
                    </tr>
                    <tr class="form editable">
                        <th>
                            Label for Referrals
                        </th>
                        <td>
                            <input type="text" name="referral_label" value="{{ module.referral_label|trans:langs }}" />
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <th>Module Name</th>
                        <td>
                            {{ module.name|html_trans:langs|safe }}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Case Type
                        </th>
                        <td>
                            <code>{{ module.case_type }}</code>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Menu
                        </th>
                        <td>
                            {% if not module.put_in_root %}
                                Put forms in a separate menu
                            {% else %}
                                Put forms on first screen
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Case List
                        </th>
                        <td>
                            {% if not module.case_list.show %}
                                Don't Show
                            {% else %}
                                Show with label: {{ module.case_list.label|trans:langs }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Label for Cases</th>
                        <td>
                            {{ module.case_label|trans:langs }}
                        </td>
                    </tr>
                    <tr>
                        <th>Label for Referrals</th>
                        <td>
                            {{ module.referral_label|trans:langs }}
                        </td>
                    </tr>
                {% endif %}
            </table>
        </form>
    </div>

    {% comment %}
    <div class="message" id="case-properties-warning">
        I can't find any properties for this module's case. To generate
        cases with properties, select "Updates a case" under a form's "Actions" and make a list of properties.
    </div>
    {% endcomment %}


    <div id="detail-screen-config"></div>
    {% comment %}
    {% for detail in module.details %}
        {% if detail.type in module.detail_types %}
            <h4>
                {% if detail.type == "case_short" %}
                    Case List View
                {% endif %}
                {% if detail.type == "case_long" %}
                    Case Full View
                {% endif %}
                {% if detail.type == "ref_short" %}
                    Referral List View
                {% endif %}
                {% if detail.type == "ref_long" %}
                    Referral Full View
                {% endif %}
            </h4>
            <table class="config detail-headers" id="{{ detail_type }}_detail">

                <thead>
                    <tr>
                        {% if edit %}
                            <th class="drag-button-column"></th>
                            <th class="delete-button-column"></th>
                        {% endif %}
                        <th class="model-column">
                            {# if we're dealing with a referral screen #}
                            {% if detail.type.0 == 'r' %}
                                Model
                            {% endif %}
                        </th>
                        <th class="field-column">Property</th>
                        <th class="header-column">Name</th>
                        <th class="format-column">Format</th>
                        <th class="enum-column">Enum</th>
                        {% if edit %}
                            <th></th>
                        {% endif %}
                    </tr>
                </thead>

                <tbody {% if edit %}class="sortable"{% endif %}>
                    {% if edit %}
                     <tr class="sort-action">
                            <td>
                                <form method="post" action="{% url corehq.apps.app_manager.views.rearrange domain app.id 'detail' %}">
                                    <input type="hidden" name="detail_type" value="{{ detail.type }}" />
                                    <input type="hidden" name="module_id" value="{{ module.id  }}" />
                                    <input type="hidden" name="ajax" value="true" />
                                </form>
                            </td>
                        </tr>
                    {% endif %}
                    {% for column in detail.get_columns %}
                        {% include "app_manager/partials/detail_column.html" %}
                    {% endfor %}
                    {% if edit %}
                        <tr class="sort-disabled form new-detail-header"
                            data-action="{% url corehq.apps.app_manager.views.edit_module_detail domain app.id module.id %}">
                            <td class="drag-button-column">
                                <input type="hidden" name="detail_type" value="{{ detail.type }}" />
                            </td>
                            <td class="delete-button-column"></td>
                            <td class="model-column">
                                {% if detail.type.0 == 'r' %}
                                    <select name="model" data-value="case">
                                        <option>case</option>
                                        <option>referral</option>
                                    </select>
                                {% else %}
                                    <input type="hidden" name="model" value="case" />
                                {% endif %}
                            </td>
                            <td class="field-column">
                                <input type="text" class="code" name="field" />
                            </td>
                            <td class="header-column">
                                <input type="text" name="header" />
                            </td>
                            <td class="format-column">
                                <select class="format code" name="format" data-value="plain">
                                    <option value="plain">plain</option>
                                    <option value="date">date</option>
                                    <option value="years-ago">years-ago</option>
                                    <option value="phone">phone</option>
                                    <option value="enum">enum</option>
                                    <option value="late-flag">late-flag</option>
{#                                    <option value="advanced">advanced</option>#}
                                </select>
                            </td>
                            <td class="enum-column">
                                <textarea name="enum"></textarea>
                            </td>
                            <td>
                                <a class="button detail-column-add" href="#">Add</a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        {% endif %}
    {% endfor %}
    {% endcomment %}
{% endblock %}