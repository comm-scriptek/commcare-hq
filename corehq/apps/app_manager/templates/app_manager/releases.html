{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load url_extras %}
{% load timezone_tags %}
{% load hq_shared_tags %}
{% load timezone_tags %}
{% load i18n %}
{% block js-inline %}{{ block.super }}
<script>
    $(function () {
        $('.release-build-link').popover({
            placement: 'left',
            title: 'Release Build',
            content: (
                "Once you've fully tested an application, you can star it to mark it as released. " +
                "When a CommCare application searches for updates, only starred builds will be considered."
            )
        });
        $('.unrelease-build-link').popover({
            placement: 'left',
            title: 'Retract Build',
            content: (
                "We recommend caution when retracting a build. Although " +
                "this build will no longer be considered when a CommCare application searches for updates, " +
                "it will not be purged from phones onto which it has already been downloaded."
            )
        });
        $('#build-errors').each(function () {
            var specialMessage = $('span', this)[0];
            var defaultMessage = $('span', this)[1];
            if ($.trim($(specialMessage).text())) {
                $(defaultMessage).hide();
            }
        });
        $('.showAccordionButton').click(function(e) {
            $($(this).attr('href')).slideDown();
            $(this).parent().hide();
            return false;
        });
    });
</script>
{% endblock %}
{% block head %}{{ block.super }}
<style>
    .build:hover {
        color: black !important;
    }
    .build.build-unreleased {
        color: #888;
    }
    .build.build-released {
    }
    .build.build-latest-release {
        background-color: #EFEFFF;
    }
    .nowrap {
        white-space: nowrap;
    }
</style>
{% endblock %}
{% block form-view %}
    <form id="make-new-build" action="{% url corehq.apps.app_manager.views.save_copy domain app.id %}" method="post">
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <input type="hidden" name="comment" value="" />
        <input type="submit" value="Make New Build" />
    </form>
    {% if build_errors %}
    <div class="message">
        Build Failed!
        <ul id="build-errors">
            {% for error in build_errors %}
            <li>
                <span>
            {% if error.type == "invalid xml" %}
                {% if error.form.content %}
                    Invalid xml in form
                {% else %}
                    Blank form
                {% endif %}
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "no ref detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses referrals but doesn't have
                detail screens configured for referrals.
            {% endif %}
            {% if error.type == "no case detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have
                detail screens configured for cases.
            {% endif %}
            {% if error.type == "no modules" %}
                This application has no modules.
            {% endif %}
            {% if error.type == "no forms" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                has no forms.
            {% endif %}
            {% if error.type == "no case type" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have a
                case type defined.
            {% endif %}
            {% if error.type == "form error" %}
                One or more forms are invalid: check all your forms for error messages.
            {% endif %}
            {% if error.type == "missing languages" %}
                {% include "app_manager/partials/form_error_message.html" %} missing languages:
                {% for lang in error.missing_languages %}
                    {{ lang }}
                {% endfor %}
            {% endif %}
            {% if error.type == "duplicate xmlns" %}
                You have two forms with the xmlns "{{ error.xmlns }}"
            {% endif %}
            {% if error.type == "update_case uses reserved word" %}
                Case Update uses reserved word "{{ error.word }}"
                in form
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "update_case word illegal" %}
                Case Update "{{ error.word }}" should start with a letter and only contain letters, numbers, '-', and '_'
                in form {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "path error" %}
                The case configuration in form
                {% include "app_manager/partials/form_error_message.html" %}
                contains the invalid path "{{ error.path }}".
            {% endif %}
            {% if error.type == "remote error" %}
                Remote Error: {{ error.message }}
            {% endif %}
            {% if error.type == "empty lang" %}
                One of your languages is empty. Check your <a href="{% url view_app domain app.id %}">app settings</a>.
            {% endif %}
                </span>
                <span>{{ error.message }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <table class="table">
        <tr>
            <th colspan="2">Version</th>
            <th colspan="2">Build Date &amp; Time</th>
            <th>CommCare Binary</th>

            <th></th>
            {% if edit %}
            <th></th>
            {% endif %}
            <th>Comment</th>
            <th>Released</th>

        </tr>
        {% for saved_app in saved_apps %}
        <tr class="build build-{% if saved_app.is_released %}released{% else %}unreleased{% endif %} {% if saved_app.id == latest_release.id %}build-latest-release{% endif %}">
            <td>
                {% if edit %}
                <form action="{% url corehq.apps.app_manager.views.delete_copy domain app.id %}"
                      data-title="Delete Build"
                      data-message="Are you sure you want to delete this build (version {{ saved_app.version }})?"
                      method="post">
                    <input type="hidden" name="saved_app" value="{{ saved_app.id }}" />
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <a class="delete_link confirm-submit" href="#"></a>
                </form>
                {% endif %}
            </td>
            <td class="nowrap">{{ saved_app.version }}</td>
            <td class="nowrap">{% utc_to_timezone saved_app.built_on timezone "%b %d, %Y" %}</td>
            <td class="nowrap">{% utc_to_timezone saved_app.built_on timezone "%H:%M %Z" %}</td>
            <td class="nowrap">
                {% if saved_app.built_with.get_label %}{{ saved_app.built_with.get_label }}{% endif %}
                <p>{{ saved_app.get_jar_path }}</p>
                {% if not saved_app.built_with.signed %}<h6>Unsigned Jar</h6>{% endif %}
            </td>
            <td class="nowrap">
                <div class="btn-group">
                    <span class="btn btn-primary" data-toggle="modal" data-target="#{{ saved_app.id }}_modal">
                        Deploy
                    </span>
                </div>
            </td>
            {% if edit %}
            <td>
                {% if saved_app.version != app.version %}
                <button class="btn dialog_opener">Revert</button>
                <form class="dialog" action="{% url corehq.apps.app_manager.views.revert_to_copy domain app.id %}" method="post"
                        title="Revert to Build">
                    <p>Are you sure you want to revert to build {{ saved_app.version }}?</p>
                    <input type="hidden" name="saved_app" value="{{ saved_app.id }}" />
                    <button class="btn btn-primary" data-dismiss="modal" type="submit">Revert</button>
                </form>
                {% endif %}
            </td>
            {% endif %}
            <td>{% if saved_app.build_comment %}{{ saved_app.build_comment }}{% else %}<h6>(No Comment)</h6>{% endif %}</td>
            <td>
                {% if saved_app.is_released %}
                    {% if edit %}
                    <a href="{% url unrelease_build domain app.id saved_app.id %}" class="unrelease-build-link">
                        <img src="{% static 'app_manager/img/star-filled.svg' %}"/><!--
                        no whitespace
                    --></a>
                    {% else %}
                        <img src="{% static 'app_manager/img/star-filled.svg' %}"/>
                    {% endif %}
                    {% if saved_app.id == latest_release.id %}Latest{% endif %}
                {% else %}
                    {% if edit %}
                    <a href="{% url release_build domain app.id saved_app.id %}" class="release-build-link">
                        <img src="{% static 'app_manager/img/star-empty.svg' %}"/>
                    </a>
                    {% else %}
                        <img src="{% static 'app_manager/img/star-empty.svg' %}"/>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
{% endblock %}

{% block modals %}
{{ block.super }}
    {% for saved_app in saved_apps %}
        <div id="{{ saved_app.id }}_modal" class="modal hide fade">
            <div class="modal-header">
            <a href="#" class="close" data-dismiss="modal">×</a>
            <h3>Deploying version {{ saved_app.version }}</h3>
            </div>
            <div class="modal-body">
            {% if saved_app.case_sharing and users_cannot_share|length > 0 %}
                <p>
                    <span class="label label-important">Warning!</span>
                    The following users cannot use this case sharing app because they have either more or less than one group. To fix this, please <a href="{% url commcare_users domain %}?cannot_share=true">edit their group settings</a> so that they all belong to exactly one group.
                </p>
                <ul>
                    {% for user in users_cannot_share %}
                        <li>{{ user.raw_username }}</li>
                    {% endfor %}
                </ul>
                <p>
                    <a href="{% url commcare_users domain %}?cannot_share=true" class="btn">Edit mobile users</a>
                    <a href="#{{ saved_app.id }}_accordion" class="btn showAccordionButton">Deploy anyway</a>
                </p>
            {% endif %}
            <div class="accordion{% if saved_app.case_sharing and users_cannot_share|length > 0 %} hide {% endif %}" id="{{ saved_app.id }}_accordion">
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle"{% if saved_app.cloudcare_enabled %} data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_preview"{% else %} href="{% url emulator domain saved_app.id %}"{% endif %}>
                      Preview
                      {% if not saved_app.cloudcare_enabled %}
                        in emulator
                      {% endif %}
                    </a>
                  </div>
                  <div id="{{ saved_app.id }}_preview" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <p>
                            Preview in <a href="{% url emulator domain saved_app.id %}">the emulator</a> or in <a href="{% url cloudcare_get_app domain saved_app.id %}">CloudCare</a>
                      </p>
                    </div>
                  </div>
                </div>
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_j2me">
                      Download to J2ME
                    </a>
                  </div>
                  <div id="{{ saved_app.id }}_j2me" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <ol>
                        <li>
                            Download <strong>both</strong> of the following files:
                            <p><a href="{% url corehq.apps.app_manager.views.download_jad domain saved_app.id %}">Download CommCare.jad</a></p>
                            <p><a href="{% url corehq.apps.app_manager.views.download_jar domain saved_app.id %}">Download CommCare.jar</a></p>
                        </li>
                        <li>
                            For help on how to install, see our <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Set+Up+Mobile+Phone">Set Up Mobile Phone</a>.
                        </li>
                        <li>
                            If you have any issues with the installation, please refer to
                            <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Troubleshooting+Phone+Problems">Troubleshooting Phone Problems</a>.
                        </li>
                    </ol>
                    </div>
                  </div>
                </div>
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_sms">
                      Send J2ME app to phone via SMS
                    </a>
                  </div>
                  <div id="{{ saved_app.id }}_sms" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <form method="post" action="{% url corehq.apps.sms.views.send_to_recipients domain %}">
                        <label>Send to: </label>
                        <input type="text" name="recipients" class="sms-autocomplete" value="{{ app.recipients }}"/>
                        <br />
                        {% if app.name|length <= 12 %}
                            <textarea name="message">Update to CommCare: {{ saved_app.short_url }} ("{{ app.name }}" v.{{ saved_app.version }})</textarea>
                        {% else %}
                            <textarea name="message">Update to CommCare: {{ saved_app.short_url }} ("{{ app.name|slice:":10" }}.." v.{{ saved_app.version }})</textarea>
                        {% endif %}
                        <br />
                        <input type="submit" class="btn" value="Send"/>
                    </form>
                    </div>
                  </div>
                </div>
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle odk_install" href="{% url corehq.apps.app_manager.views.odk_install domain saved_app.id %}">Download to CommCare ODK (Android)</a>
                  </div>
                </div>
                {% ifchanged %}
                            {% if multimedia %}
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" href="{% if multimedia.notice %}#{{ saved_app.id }}_multimedia{% else %}{% url download_multimedia_zip domain app.id %}{% endif %}" {% if multimedia.notice %}data-toggle="collapse" data-target="#{{ saved_app.id }}_multimedia"{% endif %}>Download Multimedia Zip</a>
                  </div>
                  <div class="accordion-body collapse" id="{{ saved_app.id }}_multimedia">
                    <div class="accordion-inner">
                    {% if multimedia.missing_image_refs > 0 or multimedia.missing_audio_refs > 0 %}
                        <p>
                            Your multimedia zip is missing {{ multimedia.missing_image_refs }} image reference{{ multimedia.missing_image_refs|pluralize }} and
                            {{ multimedia.missing_audio_refs }} audio reference{{ multimedia.missing_audio_refs|pluralize }}. Your app will likely crash unless this
                            is resolved.
                        </p>
                    {% endif %}
                    {% if multimedia.errors %}
                        <p>
                            Your application contains errors, therefore, your multimedia could not properly be assembled. Please fix your errors and any missing
                            multimedia references that are found afterward before using this file.
                        </p>
                    {% endif %}
                    <a class="btn btn-warning" href="{% url download_multimedia_zip domain app.id %}">Download Anyway</a>
                    </div>
                  </div>
                </div>
                            {% endif %}
                        {% endifchanged %}
                {% if request.user.is_superuser %}
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" href="{% url download_index domain saved_app.id %}">View Source Files</a>
                  </div>
                </div>
                {% endif %}
            </div>
            </div>
            <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Close</a>
            </div>
        </div>
    {% endfor %}
{% endblock %}
