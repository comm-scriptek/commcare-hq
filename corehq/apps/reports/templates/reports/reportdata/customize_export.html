{% extends "reports/base_template.html" %}
{% load hq_shared_tags %}
{% load i18n %}

{% block js-inline %}{{ block.super }}
    <script src="{{ STATIC_URL }}reports/javascripts/jquery.tablednd_0_5.js"></script>
    <script>
        $(function(){
            var update_order_input = function(){
                var orderStr = "";
                var rows = $("#field-select")[0].tBodies[0].rows;
                for (var i=0; i<rows.length; i++) {
                    var escid = rows[i].id.replace(/([ @#;&,.+*~\':"!^$[\]()=>|\/])/g,'\\$1');
                    if (escid && $("#"+escid+" .field-include")[0].checked) {
                        orderStr += rows[i].id+" ";
                    }
                }
                $("#order_input")[0].value = orderStr;

            };
            // select all/none
            $("#select_all").click(function() {
                $(".field-include").attr('checked', true);
                update_order_input();
                return false;
            });
            $("#select_none").click(function() {
                $(".field-include").attr('checked', false);
                update_order_input();
                return false;
            });

            $(".field-include").click(function(){
                update_order_input();
            });

            $('#field-select').tableDnD({
                onDragClass: "dragged",
                    onDrop: function(table, row) {
                        update_order_input();
                    }
            });
            update_order_input();
        });

        $(function () {
            var showDeidColumn = {{ show_deid_column|JSON }};
            var showDeidButton = $('#show_deid_button');
            var deidColumn = {
                el: $('.deid-column'),
                show: function () {
                    this.el.fadeIn();
                    showDeidButton.hide();
                },
                hide: function () {
                    this.el.hide();
                    showDeidButton.show();
                }
            };

            showDeidButton.click(function (e) {
                e.preventDefault();
                $('html, body').animate({
                    scrollTop: $('#field-select').offset().top + 'px'
                }, 'slow', undefined, function () {
                    deidColumn.show();
                });
            });
            if (!showDeidColumn) {
                deidColumn.hide();
            } else {
                deidColumn.show();
            }
        })
    </script>
{% endblock %}

{% block page-title %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url reports_home domain %}"><strong>{% trans "Reports" %}</strong></a> <span class="divider">&gt;</span>
        </li>
        <li>
            {% ifequal request.GET.type "case" %}
                <a href="{% url project_report_dispatcher domain 'case_export' %}">{% trans "Export Cases, Referrals, and Users" %}</a> <span class="divider">&gt;</span>
            {% else %}
            <a href="{% url project_report_dispatcher domain 'excel_export_data' %}">{% trans "Export Submissions to Excel" %}</a> <span class="divider">&gt;</span>
            {% endifequal %}
        </li>
        <li class="active">
            <a href="#">{% trans "Create Custom Export" %}</a>
        </li>
    </ul>
{% endblock %}

{% block main_column %}
    <form class="form-horizontal" method="post" action="{{ request.get_full_path|safe }}">
        <input type="hidden" name="schema" value="{{ saved_export.schema_id }}" />
        <input type="hidden" name="table" value="{{ table_config.index }}" />
        <input type="hidden" name="order" id="order_input" value="" />
        {% if saved_export.type == 'form' and saved_export.app_id %}
            <input type="hidden" name="app_id" value="{{ saved_export.app_id|default:'' }}" />
        {% endif %}
        <fieldset>
            <legend>{% trans "Export Settings" %}</legend>
            <div class="control-group">
                <label for="export-name" class="control-label">{% trans "Export Name" %}: </label>
                <div class="controls">
                    <input type="text" id="export-name" name="name" value="{{ saved_export.name }}" />
                </div>
            </div>
            <div class="control-group">
                <label for="format-select" class="control-label">{% trans "Default file type" %}: </label>
                <div class="controls">
                    <select name="format" id="format-select" >
                        <option value="xlsx"{% if saved_export.default_format == "xlsx"%} selected="selected"{% endif %}>Excel 2007</option>
                        <option value="xls"{% if saved_export.default_format == "xls" %} selected="selected"{% endif %}>Excel (older versions)</option>
                        <option value="csv"{% if saved_export.default_format == "csv"%} selected="selected"{% endif %}>CSV (Zip file)</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
            {% if saved_export.type == 'form' %}
                    <label class="checkbox">
                        <input type="checkbox" name="include-errors" id="include-errors-checkbox" value="include-errors" {% if saved_export.include_errors %}checked="yes"{% endif %}/>
                        {% trans "Include duplicates and other unprocessed forms" %}
                    </label>
            {% endif %}
                    <label class="checkbox">
                        <input type="checkbox" name="presave" id="presave-checkbox" value="presave" {% if presave %}checked="yes"{% endif %}/>
                        {% trans "Save this report daily?" %}
                    </label>
                </div>
            </div>
        </fieldset>
        <fieldset>
            <legend>{% trans "Export Fields" %}</legend>
            <div class="control-group">
                <label class="control-label">
                    <strong>{% trans "Choose the fields you want to export." %}</strong><br />
                    {% trans "You can drag and drop fields to reorder them.  You can also rename fields, which will update the headers in the export file." %}
                </label>
                <div class="controls">
                    <table class="column_list table table-striped table-bordered table-condensed" id="field-select">
                        <thead>
                        <tr class="nodrag nodrop">
                            <th>{% trans "Include this Field?" %}<br>
                                <a href="#" class="btn btn-mini" id="select_all">{% trans "Select All" %}</a> <a href="#" class="btn btn-mini btn-inverse" id="select_none">{% trans "Select None" %}</a></th>
                            <th>{% trans "Field" %}</th>
                            <th>{% trans "Display" %}</th>
                            <th class="deid-column">{% trans "Sensitivity" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for columndef in table_config.column_configuration %}
                            <tr id="{{ columndef.index }}">
                                <td><input type="checkbox" class="field-include" name="{{ columndef.index }} val" {% if columndef.selected %}checked="yes"{% endif %}></input></td>
                                <td>{{ columndef.index }}</td>
                                <td><input class="input-xlarge" name="{{ columndef.index }} display" type="text" value="{{ columndef.display }}" selected="selected" checked="true"></input></td>
                                <td class="deid-column">
                                    {% if columndef.index != 'id' or columndef.transform %}
                                    <select name="{{ columndef.index }} transform" data-value="{{ columndef.transform|default:'' }}">
                                        {% for name, value in deid_options %}
                                            <option value="{{ value }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </fieldset>
        {% if saved_export.type == 'form' %}
        <fieldset>
            <legend>Privacy Settings</legend>
            <div class="control-group">
                <label for="is_safe" class="control-label"></label>
                <div class="controls deid-column">
                    <label class="checkbox">
                        <input type="checkbox" name="is_safe" id="is_safe" value="is_safe" {% if saved_export.is_safe %}checked="yes"{% endif %}/>
                        Publish in {{ DeidExportReport_name }}
                    </label>
                    <span class="help-inline">{% trans "Check only if this export has been fully and safely de-identified." %}</span>
                </div>
                <button class="btn" id="show_deid_button">{% trans "Allow me to mark sensitive data" %}</button>
            </div>
        </fieldset>
        {% endif %}
        <div class="form-actions">
            <button type="submit" class="btn btn-large btn-primary">{% if saved_export.get_id %}Save{% else %}Create{% endif %}</button>
            <a class="btn btn-large" href="{% ifequal request.GET.type "case" %}{% url project_report_dispatcher domain 'case_export' %}{% else %}{% url project_report_dispatcher domain 'excel_export_data' %}{% endifequal %}">Cancel</a>
            {% if saved_export.get_id %}{% with saved_export as export %}
            <a class="btn btn-large btn-danger" style="float: right;"  data-toggle="modal" href="#delete-export-modal-{{ export.get_id }}"><i class="icon-remove icon-white"></i> Delete this Export</a>
            {% endwith %}{% endif %}
        </div>
    </form>
{% endblock %}


{% block modals %}{{ block.super }}
    {% if saved_export.get_id %}
        {% with saved_export as export %}
            {% include "reports/dialogs/delete_custom_export_dialog.html" %}
        {% endwith %}
    {% endif %}
{% endblock %}
