{% extends "reports/report_base.html" %}

{% block js-inline %}{{ block.super }}
    <script src="{{ STATIC_URL }}reports/javascripts/jquery.tablednd_0_5.js"></script>
    <script>
        $(function(){
            var update_order_input = function(){
                var orderStr = "";
                var rows = $("#field-select")[0].tBodies[0].rows;
                for (var i=0; i<rows.length; i++) {
                    var escid = rows[i].id.replace(/([ @#;&,.+*~\':"!^$[\]()=>|\/])/g,'\\$1');
                    if (escid && $("#"+escid+" .field-include")[0].checked) {
                        orderStr += rows[i].id+" ";
                    }
                }
                $("#order_input")[0].value = orderStr;

            };
            // select all/none
            $("#select_all").click(function() {
                $(".field-include").attr('checked', true);
                update_order_input();
                return false;
            });
            $("#select_none").click(function() {
                $(".field-include").attr('checked', false);
                update_order_input();
                return false;
            });

            $(".field-include").click(function(){
                update_order_input();
            });

            $('#field-select').tableDnD({
                onDragClass: "dragged",
                    onDrop: function(table, row) {
                        update_order_input();
                    }
            });
            update_order_input();
        });
    </script>
{% endblock %}
{% block js %}{{ block.super }}
    <!--<script src="{{ STATIC_URL }}hqwebapp/js/dialogs.js"></script>-->
{% endblock %}

{% block page-title %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url default_report domain %}"><strong>Reports</strong></a> <span class="divider">&gt;</span>
        </li>
        <li>
            {% ifequal request.GET.type "case" %}
                <a href="{% url report_dispatcher domain 'case_export' %}">Export Cases, Referrals, and Users</a> <span class="divider">&gt;</span>
            {% else %}
            <a href="{% url report_dispatcher domain 'excel_export_data' %}">Export Submissions to Excel</a> <span class="divider">&gt;</span>
            {% endifequal %}
        </li>
        <li class="active">
            <a href="#">Create Custom Export</a>
        </li>
    </ul>
{% endblock %}

{% block main_column %}
    <form class="form-horizontal" method="post" action="{{ request.get_full_path|safe }}">
        <input type="hidden" name="schema" value="{{ saved_export.schema_id }}" />
        <input type="hidden" name="table" value="{{ table_config.index }}" />
        <input type="hidden" name="order" id="order_input" value="" />
        {% if saved_export.type == 'form' and saved_export.app_id %}
            <input type="hidden" name="app_id" value="{{ saved_export.app_id|default:'' }}" />
        {% endif %}
        <fieldset>
            <legend>Export Settings</legend>
            <div class="control-group">
                <label for="export-name" class="control-label">Export Name: </label>
                <div class="controls">
                    <input type="text" id="export-name" name="name" value="{{ saved_export.name }}" />
                </div>
            </div>
            <div class="control-group">
                <label for="format-select" class="control-label">Default file type: </label>
                <div class="controls">
                    <select name="format" id="format-select" >
                        <option value="xlsx"{% if saved_export.default_format == "xlsx"%} selected="selected"{% endif %}>Excel 2007</option>
                        <option value="xls"{% if saved_export.default_format == "xls" %} selected="selected"{% endif %}>Excel (older versions)</option>
                        <option value="csv"{% if saved_export.default_format == "csv"%} selected="selected"{% endif %}>CSV (Zip file)</option>
                    </select>
                </div>
            </div>
            {% if saved_export.type == 'form' %}
            <div class="control-group">
                <label for="include-errors-checkbox" class="control-label"></label>
                <div class="controls">
                    <label class="checkbox">
                        <input type="checkbox" name="include-errors" id="include-errors-checkbox" value="include-errors" {% if saved_export.include_errors %}checked="yes"{% endif %}/>
                        Include duplicates and other unprocessed forms
                    </label>
                </div>
            </div>
            {% endif %}
        </fieldset>
        <fieldset>
            <legend>Export Fields</legend>
            <div class="control-group">
                <label class="control-label">
                    <strong>Choose the fields you want to export.</strong><br />
                    You can drag and drop fields to reorder them.  You can also rename fields, which will update the headers in the export file.
                </label>
                <div class="controls">
                    <table class="column_list table table-striped table-bordered" id="field-select">
                        <thead>
                        <tr class="nodrag nodrop">
                            <th>Include this Field?<br>
                                <a href="#" class="btn btn-mini" id="select_all">Select All</a> <a href="#" class="btn btn-mini btn-inverse" id="select_none">Select None</a></th>
                            <th>Field</th>
                            <th>Display</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for columndef in table_config.column_configuration %}
                            <tr id="{{ columndef.index }}">
                                <td><input type="checkbox" class="field-include" name="{{ columndef.index }}_val" {% if columndef.selected %}checked="yes"{% endif %}></input></td>
                                <td>{{ columndef.index }}</td>
                                <td><input name="{{ columndef.index }}_display" type="text" value="{{ columndef.display }}" selected="selected" checked="true"></input></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </fieldset>
        <div class="form-actions">
            <button type="submit" class="btn btn-large btn-primary">{% if saved_export.get_id %}Save{% else %}Create{% endif %}</button>
            <a class="btn btn-large" href="{% ifequal request.GET.type "case" %}{% url report_dispatcher domain 'case_export' %}{% else %}{% url report_dispatcher domain 'excel_export_data' %}{% endifequal %}">{% if saved_export.get_id %}Back{% else %}Cancel{% endif %}</a>
            {% if saved_export.get_id %}{% with saved_export as export %}
            <a class="btn btn-large btn-danger" style="float: right;"  data-toggle="modal" href="#delete-export-modal-{{ export.get_id }}"><i class="icon-remove icon-white"></i> Delete this Export</a>
            {% endwith %}{% endif %}
        </div>
    </form>
{% endblock %}


{% block modals %}{{ block.super }}
    {% if saved_export.get_id %}
        {% with saved_export as export %}
            {% include "reports/dialogs/delete_custom_export_dialog.html" %}
        {% endwith %}
    {% endif %}
{% endblock %}
