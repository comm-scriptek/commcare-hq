{% comment %}
This file is intended to work as an "sms-autocomplete" plugin. This gives a text input field the behavior you would
expect from an email "To:" field, that is, it autocompletes people and groups.

There are three components you have to include for this plugin to work:
1) In the view, assuming you have variables called context, request, and domain, include the lines:
    # at the top
    from sms.views import get_sms_autocomplete_context
    
    # in the view
    context.update(get_sms_autocomplete_context(request, domain)

2) In the head of your template, import this file:
    {% include "sms/partials/sms_autocomplete.html" %}

3) Give the inputs that you want to function as sms-autocompletes the class "sms-autocomplete":
    <input type="text" class="sms-autocomplete" />

That's it.

{% endcomment %}

<script>
    $(function(){

        function split( val ) {
            return val.split( /,\s*/ );
        }
        function extractLast( term ) {
            return split( term ).pop();
        }

        var availableTags = JSON.parse($("#sms_contacts").val());

        $(".sms-autocomplete")
            // don't navigate away from the field on tab when selecting an item
        .bind( "keydown", function( event ) {
            if ( event.keyCode === $.ui.keyCode.TAB &&
                    $( this ).data( "autocomplete" ).menu.active ) {
                event.preventDefault();
            }
        })
        .autocomplete({
            minLength: 0,
            source: function( request, response ) {
                // delegate back to autocomplete, but extract the last term
                var term = extractLast( request.term );

                if(term) {
                    response( $.ui.autocomplete.filter(
                        availableTags,  term) );
                }
                else {
                    response([]);
                }
            },
            focus: function() {
                // prevent value inserted on focus
                return false;
            },
            select: function( event, ui ) {
                var terms = split( this.value );
                // remove the current input
                terms.pop();
                // add the selected item
                terms.push( ui.item.value );
                // add placeholder to get the comma-and-space at the end
                terms.push( "" );
                this.value = terms.join( ", " );
                return false;
            }
        })
        .focus(function(){
            $(this).autocomplete('search');
        });
    });
</script>

<textarea style="display: none" id="sms_contacts">{{ sms_contacts }}</textarea>

