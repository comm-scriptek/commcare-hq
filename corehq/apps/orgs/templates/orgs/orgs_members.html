{% extends "orgs/orgs_landing.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
<script src="{% static 'hqwebapp/javascripts/knockout.mapping.js' %}"></script>
<script src="{% static 'hqwebapp/js/knockout-bindings.js' %}"></script>
<script src="{% static 'users/js/roles.js' %}"></script>
<script src="{% static 'users/js/selectText.js' %}"></script>

{% endblock %}
{% block js-inline %}{{ block.super }}
<script>
    $(function () {
                $('#user-roles-table').userRoles({
                    userRoles: {{ user_roles|JSON }},
            defaultRole: {{ default_role|JSON }},
    });
    $('#user-roles-table').show();
    });
</script>
{% endblock %}
{% block head %}
{{ block.super }}
<style>
</style>
{% endblock %}

{% block breadcrumb %}
        <li><span class="divider">&gt;</span> <a href="#">Members</a></li>
{% endblock %}

{% block org_content %}
<div class="row-fluid">
    <div>
        <h2>Members of Organization "{{ org.title }}"</h2>
        <div class="btn-toolbar">
            <a class="btn btn-success" href="{% url orgs_add_member org.name %}"><i class="icon icon-white icon-plus"></i> Invite Web User</a>
        </div>

        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>{% trans "E-mail" %}</th>
                <th>{% trans "Role" %}</th>
                <th>{% trans "Name" %}</th>
                <th>{% trans "Phone Numbers" %}</th>
                <th>{% trans "Remove" %}</th>
            </tr>
            </thead>
            <tbody>
            {% for user in members %}
            <tr>
                <td>
                    {{ user.html_username|safe }}

                </td>
                <td>{% if user.role_label %}{{ user.role_label }}{% else %}<h6>(No Name)</h6>{% endif %}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td>
                    {% if user.phone_numbers %}
                    +{{ user.default_phone_number }}
                    {% if user.phone_numbers.1 %}
                    (and more)
                    {% endif %}
                    {% else %}{% endif %}
                </td>
                <td>
                    {% ifnotequal request.user.username user.username %}
                    <form style="margin-bottom: 0;" action="{% url orgs_remove_member org.name user.get_id %}" method="post">
                        <button type="submit" class="btn btn-danger"><i class="icon icon-white icon-remove"></i> Remove Membership</button>
                    </form>
                    {% endifnotequal %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <h2>Roles</h2>
        <div id="user-roles-table" style="display: none;">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th></th>
                    <th>Edit Projects</th>
                    <th>Edit Teams</th>
                    <th>Edit Members</th>
                    <th>View Teams</th>
                    <th data-bind="visible: allowEdit"></th>
                </tr>
                </thead>
                <tbody data-bind="foreach: userRoles">
                <tr>
                    <th>
                        <span data-bind="visible: name, text: name"></span>
                        <h6 data-bind="visible: !name()">(No Name)</h6>
                    </th>
                    <td><i data-bind="staticChecked: permissions.edit_web_users"></i></td>
                    <td><i data-bind="staticChecked: permissions.edit_commcare_users"></i></td>
                    <td><i data-bind="staticChecked: permissions.edit_data"></i></td>
                    <td><i data-bind="staticChecked: permissions.edit_apps"></i></td>
                    <td>
                        <span data-bind="visible: reportPermissions.all(), staticChecked: true"></span>
                        <div data-bind="visible: !reportPermissions.all() && reportPermissions.filteredSpecific().length">
                            Only
                            <ul data-bind="foreach: reportPermissions.specific">
                                <li data-bind="html: name, visible: value"></li>
                            </ul>
                        </div>
                        <span data-bind="visible: !reportPermissions.all() && !reportPermissions.specific().length, staticChecked: false"></span>
                    </td>
                    <td data-bind="visible: $root.allowEdit">
                        <button class="btn" data-bind="css: {disabled: !$data._id}, click: $data._id ? $root.setRoleBeingEdited : null">
                            <i class="icon-edit"></i>Edit Role
                        </button>
                    </td>
                    <!--<td>-->
                    <!--<button class="btn btn-danger" data-bind="visible: $data._id, click: $root.setRoleBeingEdited">-->
                    <!--<i class="icon-white icon-trash"></i>-->
                    <!--Delete Role-->
                    <!--</button>-->
                    <!--</td>-->
                </tr>
                </tbody>
            </table>
            <button class="btn btn-primary" data-bind="click: function () {$root.setRoleBeingEdited($root.defaultRole)}">Add Role</button>
            <div data-bind="modal: roleBeingEdited">
                <div data-bind="with: roleBeingEdited">
                    <div class="modal-header">
                        <a class="close" data-bind="click: $root.unsetRoleBeingEdited">Ã—</a>
                        <h3 data-bind="text: modalTitle"></h3>
                    </div>
                    <div class="modal-body">
                        <input data-bind="value: name" placeholder="Role Name"/>
                        <table class="table table-bordered">
                            <tr>
                                <th width="33%">Edit Web Users</th>
                                <td>
                                    <input type="checkbox" data-bind="checked: permissions.edit_web_users"/>
                                </td>
                            </tr>
                            <tr>
                                <th>Edit {% commcare_user %}s</th>
                                <td>
                                    <input type="checkbox" data-bind="checked: permissions.edit_commcare_users"/>
                                </td>
                            </tr>
                            <tr>
                                <th>Edit Data</th>
                                <td>
                                    <input type="checkbox" data-bind="checked: permissions.edit_data"/>
                                </td>
                            </tr>
                            <tr>
                                <th>Edit Apps</th>
                                <td>
                                    <input type="checkbox" data-bind="checked: permissions.edit_apps"/>
                                </td>
                            </tr>
                            <tr>
                                <th>View All Reports</th>
                                <td>
                                    <input type="checkbox" data-bind="checked: reportPermissions.all"/>
                                </td>
                            </tr>
                            <tr data-bind="visible: !reportPermissions.all()">
                                <th>View Specific Reports</th>
                                <td>
                                    <div data-bind="foreach: reportPermissions.specific, visibleFade: !reportPermissions.all()">
                                        <div>
                                            <input type="checkbox" data-bind="checked: value"/>
                                            <span data-bind="html: name"></span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <a href="#" class="btn" data-bind="click: $root.unsetRoleBeingEdited">Cancel</a>
                        <!-- Couldn't figure out how else to get the space in there... sorry!!!-->
                        <div style="display: inline-block; width: 5px"></div>
                        <span data-bind="saveButton2: $root.modalSaveButton.state, saveOptions: $root.modalSaveButton.saveOptions"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row-fluid">
    {% if user.is_superuser %}
    <div class="span6">
        <div class="btn-toolbar"><a id="show_all_web_users_emails" class="btn" href="#">Copy and paste admin emails</a></div>
        <div id="all_web_users_emails" class="well hide">
            {% for user in web_users %}
            {% if user.is_domain_admin %}
            {% if user.first_name or user.last_name %}
            "{{ user.first_name }} {{ user.last_name }}"
            &lt;{{ user.username }}&gt;,
            {% else %}
            {{ user.username }},
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
{% endblock %}